<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>سامانه زمان‌بندی تعمیرات</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
  <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
  <style>
    #map { height: 300px; border: 1px solid #ddd; }
    pre { direction: ltr; }
    .plan-map { height: 200px; margin-bottom: 10px; }
    .assignment-card { border-left: 4px solid #007bff; }
    .unassigned-card { border-left: 4px solid #dc3545; }
  </style>
</head>

<body>
  <header class="bg-primary text-light text-center py-3">
    <h4>سامانه تخصیص و زمان‌بندی تعمیرات — نسخهٔ تعاملی</h4>
  </header>

  <main class="container my-4">
    <div class="row">
      <!-- سمت چپ: خروجی برنامه -->
      <div class="col-lg-6">
        <div class="card p-3 mb-3">
          <button class="btn btn-outline-primary mb-3" data-bs-toggle="modal" data-bs-target="#paramsModal">
            <i class="fa fa-cog"></i> تنظیم پارامترها
          </button>
          <h6>تولید برنامه</h6>
          <p class="text-muted small">پس از وارد کردن کارها و گروه‌ها، دکمه زیر را بزنید.</p>
          <button id="generatePlan" class="btn btn-primary w-100"><i class="fa fa-calendar-check"></i> تولید برنامه هفته</button>
          <div class="mt-2">
            <button id="exportExcel" class="btn btn-success w-100" disabled><i class="fa fa-file-excel"></i> دانلود اکسل برنامه</button>
          </div>
          <div id="planStatus" class="mt-2"></div>
        </div>

        <div id="planOutput" class="card p-3" style="min-height:200px; max-height:600px; overflow:auto;">
          <h6>خروجی برنامه</h6>
          <div id="planContent">هیچ برنامه‌ای تولید نشده.</div>
        </div>
      </div>

      <!-- سمت راست: فرم‌ها -->
      <div class="col-lg-6">
        <ul class="nav nav-tabs" id="tabs">
          <li class="nav-item"><button class="nav-link active" data-bs-target="#jobsTab" data-bs-toggle="tab">کارها</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-target="#crewsTab" data-bs-toggle="tab">گروه‌ها</button></li>
        </ul>

        <div class="tab-content border p-3">
          <!-- Jobs -->
          <div class="tab-pane show active" id="jobsTab">
            <form id="jobForm" class="row g-2">
              <div class="col-6">
                <label class="form-label">ID</label>
                <input id="jobId" class="form-control" required>
              </div>
              <div class="col-6">
                <label class="form-label">اولویت</label>
                <select id="jobPriority" class="form-select"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
              </div>
              <div class="col-6">
                <label class="form-label">ساعت-نفر تخمینی</label>
                <input id="jobHours" type="number" step="0.1" class="form-control" value="3">
              </div>
              <div class="col-6">
                <label class="form-label">آدرس</label>
                <input id="jobAddress" class="form-control" placeholder="متن اختیاری">
              </div>

              <div class="col-12">
                <label class="form-label">قیود (انتخاب/عدم انتخاب)</label><br>
                <div class="form-check form-check-inline">
                  <input class="form-check-input constraint-chk" type="checkbox" id="c_only_saturday" value="only_saturday">
                  <label class="form-check-label" for="c_only_saturday">فقط شنبه</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input constraint-chk" type="checkbox" id="c_finish_by_monday" value="finish_by_monday">
                  <label class="form-check-label" for="c_finish_by_monday">پایان تا دوشنبه</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input constraint-chk" type="checkbox" id="c_requires_crane" value="requires_crane">
                  <label class="form-check-label" for="c_requires_crane">نیاز به جرثقیل</label>
                </div>
              </div>

              <div class="col-12 mt-2">
                <label class="form-label">انتخاب موقعیت در نقشه (کلیک کنید)</label>
                <div id="map"></div>
                <div class="row g-2 mt-2">
                  <div class="col-6"><input id="jobLat" placeholder="lat" class="form-control" /></div>
                  <div class="col-6"><input id="jobLon" placeholder="lon" class="form-control" /></div>
                </div>
              </div>

              <div class="col-12 text-end mt-2">
                <button class="btn btn-success" type="submit"><i class="fa fa-plus"></i> افزودن کار</button>
                <button id="saveJobsToDB" class="btn btn-primary ms-2" type="button"><i class="fa fa-save"></i> ذخیره در دیتابیس</button>
                <button id="showDatasetBtn" class="btn btn-outline-secondary ms-2" type="button">نمایش دیتاست</button>
              </div>
            </form>

            <hr>
            <h6>لیست کارها</h6>
            <div class="table-responsive">
              <table class="table table-sm" id="jobsTable">
                <thead class="table-light">
                  <tr>
                    <th>شناسه</th>
                    <th>اولویت</th>
                    <th>ساعت-نفر</th>
                    <th>آدرس</th>
                    <th>عرض جغرافیایی</th>
                    <th>طول جغرافیایی</th>
                    <th>قیود</th>
                    <th>حذف</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Crews -->
          <div class="tab-pane" id="crewsTab">
            <form id="crewForm" class="row g-2">
              <div class="col-6"><label class="form-label">ID</label><input id="crewId" class="form-control" required></div>
              <div class="col-6"><label class="form-label">برچسب</label><input id="crewLabel" class="form-control"></div>
              <div class="col-4"><label class="form-label">اعضا</label><input id="crewMembers" type="number" min="1" class="form-control" value="3"></div>
              <div class="col-4"><label class="form-label">ظرفیت هر عضو (ساعت)</label><input id="crewPerMemberCap" type="number" step="0.5" min="1" max="6" class="form-control" value="6"></div>
              <div class="col-4"><label class="form-label">مهارت‌ها ( , جداکننده)</label><input id="crewSkills" class="form-control" placeholder="crane,high_voltage"></div>
              <div class="col-6"><label class="form-label">lat</label><input id="crewLat" class="form-control" value="36.317054"></div>
              <div class="col-6"><label class="form-label">lon</label><input id="crewLon" class="form-control" value="59.473879"></div>

              <div class="col-12 text-end">
                <button class="btn btn-success" type="submit"><i class="fa fa-plus"></i> افزودن گروه</button>
                <button id="saveCrewsToDB" class="btn btn-primary ms-2" type="button"><i class="fa fa-save"></i> ذخیره در دیتابیس</button>
              </div>
            </form>

            <hr>
            <h6>لیست گروه‌ها</h6>
            <div class="table-responsive">
              <table class="table table-sm" id="crewsTable">
                <thead class="table-light">
                  <tr>
                    <th>انتخاب</th>
                    <th>ID</th>
                    <th>نام</th>
                    <th>اعضا</th>
                    <th>ظرفیت</th>
                    <th>مهارت‌ها</th>
                    <th>حذف</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="text-end mt-2">
              <button id="deleteSelectedCrews" class="btn btn-danger" disabled><i class="fa fa-trash"></i> حذف گروه‌های انتخاب شده</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- مودال تنظیم پارامترها -->
  <div class="modal fade" id="paramsModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">تنظیم پارامترهای برنامه‌ریزی</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="paramsForm">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">ساعت شروع کار</label>
                  <input type="time" class="form-control" id="startTime" value="08:00" step="900">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">ساعت پایان کار</label>
                  <input type="time" class="form-control" id="endTime" value="14:00" step="900">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">حداکثر ساعت کاری</label>
                  <input type="number" class="form-control" id="maxHours" value="6" step="0.5" min="1" max="12">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">زمان انتقال بین کارها (ساعت)</label>
                  <input type="number" class="form-control" id="travelTime" value="1.0" step="0.25" min="0" max="3">
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">زمان استراحت (ساعت)</label>
              <input type="number" class="form-control" id="breakTime" value="0.5" step="0.25" min="0" max="2">
            </div>
            <div class="row mt-2">
              <div class="col-md-6">
                <label class="form-label">موقعیت پایگاه پیش‌فرض - lat</label>
                <input type="text" class="form-control" id="defaultBaseLat" value="36.317054">
              </div>
              <div class="col-md-6">
                <label class="form-label">موقعیت پایگاه پیش‌فرض - lon</label>
                <input type="text" class="form-control" id="defaultBaseLon" value="59.473879">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
          <button type="button" class="btn btn-primary" onclick="saveWorkingParams()">ذخیره پارامترها</button>
        </div>
      </div>
    </div>
  </div>

  <footer class="text-center py-3">© 2025</footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>