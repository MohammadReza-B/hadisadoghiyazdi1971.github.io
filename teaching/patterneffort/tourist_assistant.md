---
layout: persian
classes: wide rtl-layout
dir: rtl
title: "ุฑุงูููุง ฺฏุฑุฏุดฺฏุฑ - Tourist Assistant"
permalink: /teaching/studenteffort/patterneffort/TOURIST_ASSISTANT/
author_profile: true

header:
  overlay_image: "/assets/images/background.jpg"
  overlay_filter: 0.3
  overlay_color: "#5e616c"
  caption: "Photo credit: [**Unsplash**](https://unsplash.com)"
---



<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="https://upload.wikimedia.org/wikipedia/fa/e/e3/FUM_Logo.png" width="169" height="217" alt="FUM_LOGO" style="object-fit: contain;">
</div>


**ููุณูุฏู:** ูุญูุฏุฑุถุง ุจุงุจุงฺฏู  
**ุงูููู:** MohammadRezaBabagoli.AI@gmail.com  
ุฏุงูุดุฌู ุงุฑุดุฏ ููุดโ ูุตููุน ุฏุงูุดฺฏุงู ูุฑุฏูุณ ูุดูุฏ  
ุขุฒูุงุดฺฏุงู ุดูุงุณุง ุงูฺฏู ุฏฺฉุชุฑ ูุงุฏ ุตุฏูู ุฒุฏ  

# ุฑุงูููุง ฺฏุฑุฏุดฺฏุฑ - Tourist Assistant

<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/human_robot.jpeg" width="700" height="435"  alt="human_robot"  style="object-fit: contain;">
</div>  
  
## ููุฏูู

**ุฏุณุชุงุฑ ูพุดููุงุฏุฏููุฏูโ ุณูุฑ ุจุฑุง ฺฏุฑุฏุดฺฏุฑุงู:**  
ูุฏูุ ุทุฑุงุญ ุณุณุชู ุงุณุช ฺฉู ฺฉุงุฑุจุฑ ุฏุฑ ุขู ูฺฺฏโูุง ู ูุนุงุฑูุง ููุฑุฏูุธุฑ ุฎูุฏ ุจุฑุง ููุตุฏ ุณูุฑ ุฑุง ูุงุฑุฏ ูโฺฉูุฏุ ุณูพุณ ุณุณุชู ุจุฑ ุงุณุงุณ ุงู ุงุทูุงุนุงุชุ ููุงุณุจโุชุฑู ุดูุฑูุง ุฑุง ูพุฏุง ฺฉุฑุฏู ู ฺฏุฒููโูุง ูุฑุชุจุท ุฑุง ุจู ุงู ูพุดููุงุฏ ูโุฏูุฏ.

## ุงุจุฒุงุฑูุง ููุฑุฏ ุงุณุชูุงุฏู

- **LangChain:** ุจุฑุง ุณุงุฎุช ููุชูุฑ ุฌุณุชุฌู  
ูุณุชูุฏุงุช LangChain: <a href="https://docs.langchain.com/oss/python/langchain/overview" target="_blank">LangChain Documentation</a>
- **Google Gemini:** ุจุฑุง ุณุงุฎุช embeddingูุง ุงุฒุทุฑู API  
 <a href="https://aistudio.google.com/app/apikey" target="_blank">ุฏุฑุงูุช API KEY ุจุฑุง GEMINI
</a>

- **FAISS:** ุจุฑุง ุฐุฎุฑู ุณุงุฒ indexูุง ู ุงูุฌุงู ุนูู ุฌุณุชุฌู
ฺฉุชุงุจุฎุงูู FAISS ฺฉู ุชูุณุท  Facebook AI Research ุชูุณุนู ุงูุชู ุงุณุชุ ฺฉ ุงุจุฒุงุฑ ูุฏุฑุชููุฏ ู ุจููู ุจุฑุง ุฌุณุชโูุฌู ุดุจุงูุช ู ุจุงุฒุงุจ ุจุฑุฏุงุฑูุง ุฏุฑ ููุงุณ ุจุฒุฑฺฏ ูุญุณูุจ ูโุดูุฏ. ุงู ฺฉุชุงุจุฎุงูู ุจุง ุจูุฑูโฺฏุฑ ุงุฒ ุณุงุฎุชุงุฑูุง ุฏุงุฏู ู ุงูฺฏูุฑุชูโูุง ูพุดุฑูุชูุ ุงูฺฉุงู ุงุฌุฑุง ุฌุณุชโูุฌู ุชูุฑุจ ุง ุฏูู ุจุฑ ุฑู ููููโูุง ุชุง ููุงุฑุฏูุง ุจุฑุฏุงุฑ ุฑุง ุจุง ุณุฑุนุช ู ฺฉุงุฑุง ุจุงูุง ูุฑุงูู ูโฺฉูุฏ ู ุจูโูฺู ุฏุฑ ุณุงูุงููโูุง ุชูุตูโฺฏุฑุ ุฌุณุชโูุฌู ูุนูุง ู ฺฉุงุฑุจุฑุฏูุง ูุฑุชุจุท ุจุง ููุด ูุตููุน ู ุงุฏฺฏุฑ ุนูู ููุฑุฏ ุงุณุชูุงุฏู ูุฑุงุฑ ูโฺฏุฑุฏ.
<div style="background-color: #fff8b3; padding: 10px; border-radius: 8px;">
>  ูโุชูุงูุฏ ุฌูุช ุขุดูุง ุจุดุชุฑ ุจุง FAISS ููุงูู ุฒุฑ ุฑุง ูุทุงูุนู ฺฉูุฏ:  <br>
 <a href="https://hadisadoghiyazdi1971.github.io/teaching/studenteffort/patterneffort/Text_Clustering_FAISS/" target="_blank">ุฎูุดูโุจูุฏ ูุชู ุจุง ุงุจุฒุงุฑ FAISS</a>
 </div>

- **Streamlit:** ุฑุงุจุท ฺฉุงุฑุจุฑ
ฺฉุชุงุจุฎุงูู Streamlit ฺฉ ูุฑูโูุฑฺฉ ูุชูโุจุงุฒ ุฏุฑ ูพุงุชูู ุงุณุช ฺฉู ุงูฺฉุงู ุชูุณุนูโ ุณุฑุน ู ฺฉุงุฑุขูุฏ ุจุฑูุงููโูุง ุชุนุงูู ุชุญุช ูุจ ุฑุงุ ุจูโูฺู ุจุฑุง ูพุฑูฺูโูุง ุฏุงุฏูโูุญูุฑ ู ุงุฏฺฏุฑ ูุงุดูุ ูุฑุงูู ูโุณุงุฒุฏ. ุงู ฺฉุชุงุจุฎุงูู ุจุง ุญุฏุงูู ฺฉุฏููุณ ู ุจุฏูู ูุงุฒ ุจู ุฏุงูุด ููุงูุฑโูุง ูุจุ ุงูฺฉุงู ุงุฌุงุฏ ุฏุงุดุจูุฑุฏูุง ู ุฑุงุจุทโูุง ฺฉุงุฑุจุฑ ฺฉุงุฑุจุฑุฏ ู ุญุฑููโุง ุฑุง ููุง ูโฺฉูุฏ.
<div style="background-color: #fff8b3; padding: 10px; border-radius: 8px;">
>  ูโุชูุงูุฏ ุฌูุช ุขุดูุง ุจุดุชุฑ ุจุง Streamlit ุฏูุฑู ุขููุฒุด ุฒุฑ ุฑุง ุชูุงุดุง ฺฉูุฏ:  <br>
 <a href="https://www.aparat.com/v/fawilv2?playlist=12980587" target="_blank">ุขููุฒุด Streamlit</a>
 </div>



## ูุฌููุนู ุฏุงุฏูโูุง

ุงุทูุงุนุงุช ุดูุฑูุง ุฑุง ุฏุฑ ูุงู ุงฺฉุณู ุจุง ูุงู `city_data.xlsx` ุฐุฎุฑู ูโฺฉูู.
ุงู ูุงู ุดุงูู ุฏู ุณุชูู ุจู ูุงูโูุง ุฒุฑ ุงุณุช:
- `city_name`: ูุงู ุดูุฑ
- `description`: ุชูุถุญุงุช ุฌุงูุน ุงุฒ ุดูุฑ

<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/city_data.png" alt="city_data" style="width: 75%; height: 75%; object-fit: contain;">
</div>
<p class="wp-caption-text" style="margin-top: 8px; color: #555; align-items: center; text-align: center;">
       ุณุงุฎุชุงุฑ ูุฌููุนูโุฏุงุฏู - ุดุงูู ุฏู ุณุชูู: ูุงู ุดูุฑ ู ุชูุถุญุงุช ุดูุฑ
</p>

ููฺูู ุจุฑุง ูุฑ ุดูุฑุ ุชุตุงูุฑ ฺูุฏ ูฺฉุงู ุชูุฑุณุช
ุขู ุดูุฑ ุฏุฑ ูพูุดูโูุง ูุฑุจูุทู ุฐุฎุฑู ูโุดูุฏ.
<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/city_folders.png" alt="city_data" style="width: 25%; height: 25%; object-fit: contain;">
</div>
<p class="wp-caption-text" style="margin-top: 8px; color: #555; align-items: center; text-align: center;">
       ุจู ุงุฒุง ูุฑ ุดูุฑุ ฺฉ ูพูุดู ุงุฌุงุฏ ูโฺฉูู.
</p>

<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/Shiraz_folder.png" alt="city_data" style="width: 25%; height: 25%; object-fit: contain;">
</div>
<p class="wp-caption-text" style="margin-top: 8px; color: #555; align-items: center; text-align: center;">
       ุฏุฑ ุดูุฑ(ูุซูุง ุดุฑุงุฒ)ุ ุจุฑุง ูุฑ ูฺฉุงู ุฏุฏู ูพูุดู ุฏุฑ ูุธุฑ ูโฺฏุฑู.
</p>

<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/TakhtJamshid_folder.png" alt="city_data" style="width: 50%; height: 50%; object-fit: contain;">
</div>
<p class="wp-caption-text" style="margin-top: 8px; color: #555; align-items: center; text-align: center;">
       ุฏุฑ ูุฑ ูพูุดู ุจุฑุง ูฺฉุงู ุฏุฏูุ ุชุตุงูุฑ ูุฑุจูุท ุจู ุขู ูฺฉุงู ุฑุง ุฐุฎุฑู ูโฺฉูู. (ูุซูุง ุชุฎุช ุฌูุดุฏ)
</p>


## ูุนูุงุฑ ุณุณุชู

<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/system_architecture.png" alt="city_data" style="width: 95%; height: 95%; object-fit: contain;">
</div>
<p class="wp-caption-text" style="margin-top: 8px; color: #555; align-items: center; text-align: center;">
       ูุนูุงุฑ ุณุณุชู
</p>


## ุจุฎุดโูุง ุงุตู ุจุฑูุงูู

ฺูุงุฑ ุจุฎุด ุงุตู ุจุฑูุงูู ุนุจุงุฑุช ุงูุฏ ุงุฒ:
### 1. **Documents and Document Loaders**  
ุฏุฑ ุงู ุจุฎุดุ ุงุทูุงุนุงุช ูุฌููุนูโุฏุงุฏู ุงฺฉุณู ุฎูุฏ ุฑุง ุจุงุฑฺฏุฒุงุฑ ฺฉุฑุฏู ู ุจู ููุน Document ุฏุฑ LangChain ุชุจุฏู ูโฺฉูู.
ุจู ููุฑุงู ุชูุถุญุงุช ูุฑ ุดูุฑุ ูุชุงุฏุชุง ุขู (ูุงู ุดูุฑ) ุฑุง ูุฒ ุฐุฎุฑู ูโฺฉููุ ุฒุฑุง ุฏุฑ ููฺฏุงู ุจุงุฒุงุจ ุชุตุงูุฑ ูฺฉุงูโูุง ุขู ุดูุฑ ฺฉุงุฑุจุฑุฏ ุฏุงุฑุฏ.

```python
#----1. Documents and Document Loaders----#
city_data = pd.read_excel("city_data.xlsx")
documents = []
print("Building Langchain Document")
for i, row in city_data.iterrows():
    city_name = row['city_name']
    city_description = row['description']

    doc = Document(
        page_content=city_description,
        metadata={"city_name": city_name},
    )
    documents.append(doc)
```

### 2.  **Embeddings**  
ุงุจุชุฏุง ฺฉ ูุงู ุจุง ูพุณููุฏ `.env` ุฏุฑ ูุณุฑ ุจุฑูุงูู ุงุฌุงุฏ ฺฉูุฏุ ู ฺฉูุฏ API ุฎูุฏ ุฑุง ูุงููุฏ ุชุตูุฑ ุฒุฑ ุฏุฑ ุขู ูุฑุงุฑ ุฏูุฏ.

<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/dotenv_apikey.png" alt="dotenv_apikey" style="width: 50%; height: 50%; object-fit: contain;">
</div>
<p class="wp-caption-text" style="margin-top: 8px; color: #555; align-items: center; text-align: center;">
      ูุญุชูุงุช ูุงู `.env`
</p>

ุฏุฑ ุงู ุจุฎุดุ ุงุจุชุฏุง API KEY ููุฌูุฏ ุฏุฑ ูุงู `.env` ุจุงุฑฺฏุฒุงุฑ ูโุดูุฏุ
ุงฺฏุฑ API KEY ุจูโุฏุฑุณุช ุจุงุฑฺฏุฒุงุฑ ูุดูุฏุ ุฏุฑ ุงุจุชุฏุง ุงุฌุฑุง ุจุฑูุงูู ูโุชูุงูุฏ API KEY ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ.

ุฒูุงูู ูู API KEY ุจุงุฑฺฏุฒุงุฑ ุดุฏุ  ูุฏู embedding ูุฑุงุฎูุงู ูโุดูุฏ.

```python
#-----2. Embeddings------#
print("Step 2. Embeddings")
load_dotenv()

if not os.environ.get("GOOGLE_API_KEY"):
    os.environ["GOOGLE_API_KEY"] = getpass.getpass("Enter API key for Google Gemini: ")

print("API KEY Loaded.")

embeddings = GoogleGenerativeAIEmbeddings(model="models/gemini-embedding-001")
print("Embedding model loaded: gemini-embedding-001")
```

### 3.  **Vector stores**
ุฏุฑ ุงู ุจุฎุดุ ููุจุช ุจู ุณุงุฎุช index ูโุฑุณุฏุ ุงุฒ FAISS ุจุฑุงุณ ุณุงุฎุช index ุงุฒ ููุน FlatL2 ุงุณุชูุงุฏู ูโฺฉูู.

ููฺูู ุดูุง ูโุชูุงูุฏ ุงููุน ุฏฺฏุฑ ุงุฒ vector store ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ:
<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/types_of_vector_store.png" alt="out9" style="width: 75%; height: 75%; object-fit: contain;">
</div>
<p class="wp-caption-text" style="margin-top: 8px; color: #555; align-items: center; text-align: center;">
ุงููุงุน ูุฎุชูู vector store
</p>


```python
#----3. Vector stores----#
print("Step 3. Vector stores")
embedding_dim = len(embeddings.embed_query("hello world"))
index = faiss.IndexFlatL2(embedding_dim)

vector_store = FAISS(
    embedding_function=embeddings,
    index=index,
    docstore=InMemoryDocstore(),
    index_to_docstore_id={},
)
ids = vector_store.add_documents(documents=documents)
```

**ูฺฉุชู:** ุฏุฑ ุตูุฑุช ฺฉู ูุฌููุนูโุฏุงุฏู ุดูุง ุชุบุฑ ููโฺฉูุฏุ ุจูุชุฑ ุงุณุช ุฒูุงู ฺฉู ฺฉุจุงุฑ vector store ุงุฌุงุฏ ฺฉุฑุฏุฏุ ุขู ุฑุง ุจุง ุฏุณุชูุฑ ุฒุฑ ุฏุฑ ุณุณุชู ุฎูุฏ ุฐุฎุฑู ฺฉูุฏ ุชุง ุฏุฑ ุฏูุนุงุช ุจุนุฏ ูุงุฒ ุจู ุณุงุฎุช ูุฌุฏุฏ vector store ุชฺฉุฑุงุฑ ูุจุงุดุฏ.
ุงู ฺฉุงุฑ ุจุงุนุซ ุตุฑููโุฌู ุฏุฑ ูุฒูู ู ุฒูุงู ุดูุง ูโุดูุฏ.

**ูุญูู ุฐุฎุฑู vector store:**
```python
# Save to disk
vector_store.save_local("city_data_faiss_index")
```

ุจุง ุงุฌุฑุง ุงู ุฏุณุชูุฑุ ฺฉ ูพูุดู ุดุงูู ุฏู ูุงู ุจู ูุงูโูุง `index.faiss` ู `index.pkl` ุงุฌุงุฏ ูโุดูุฏ. 
<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/save_vector_store.png" alt="save_vector_store" style="width: 25%; height: 25%; object-fit: contain;">
</div>
<p class="wp-caption-text" style="margin-top: 8px; color: #555; align-items: center; text-align: center;">
      ุฐุฎุฑู vector store
</p>


**ูุญูู ุจุงุฑฺฏุฒุงุฑ ูุฌุฏุฏ vector store:**
```python
# Load from disk later
loaded_store = FAISS.load_local("city_data_faiss_index", embeddings, allow_dangerous_deserialization=True)
```

### 4.  **Retriever**

ุฏุฑ LangChain ุRetriever  ูุงฺูู ุงุณุช ฺฉู ุจุฑ ุงุณุงุณ ูพุฑุณุด ฺฉุงุฑุจุฑุ ูุฑุชุจุทโ ุชุฑู ุงุณูุงุฏ ุง ุจุฎุดโูุง ุงุทูุงุนุงุช ุฑุง ุงุฒ ฺฉ ููุจุน ุฏุงุฏู ุจุงุฒุงุจ ูโฺฉูุฏ.

ุฏุฑ ุงู ุจุฎุด ูุดุฎุต ูโฺฉูู ุนูู ุจุงุฒุงุจ ฺฺฏููู ุงูุฌุงู ุดูุฏุ ููฺูู ูุดุฎุต ูโฺฉูู ุชุนุฏุงุฏ ฺูุฏ ุณูุฏ ูุดุงุจู ุจุงุฒฺฏุดุช ุฏุงุฏู ุดููุฏ.

```python
#----4. Retriever----#
print("Step 4. Retriever")

retriever = loaded_store.as_retriever(
    search_type="similarity",
    search_kwargs={"k": 2},
)
```

`search_type="similarity"`:
 ุนู ุฑูุด ุจุงุฒุงุจ ุดุจุงูุช ุจุฑุฏุงุฑ (vector similarity) ุงุณุชูุงุฏู ุดูุฏ โ ุนู ุงุณูุงุฏ ูพุฏุง ูโุดููุฏ ฺฉู embedding ุขูโูุง ุงุฒ ูุธุฑ ยซุดุจู ุจูุฏูยป ุจู embedding ูพุฑุณุด (query) ูุฒุฏฺฉ ุจุงุดุฏ.
 
ุงููุงุน ููฺฉู ุจุฑุง `search_type`:

#### 1. `"similarity"`:  
ููุงู ยซุฌุณุชุฌู ูุจุชู ุจุฑ ุดุจุงูุช ุจุฑุฏุงุฑยป (ุจุฑุฏุงุฑ embedding ูพุฑุณุด ู ุงุณูุงุฏ).

ุฏุฑ ุงู ููุน ุฌุณุชุฌูุ ูุฑุงุญู ุฒุฑ ุงูุฌุงู ูโุดูุฏ:


1. **ุชุจุฏู ูพุฑุณุด ุจู ุจุฑุฏุงุฑ embedding**
   ุงุจุชุฏุง ูพุฑุณุด ฺฉุงุฑุจุฑ ุจุง ูุฏู embedding ุจู ฺฉ ุจุฑุฏุงุฑ ุนุฏุฏ ุชุจุฏู ูโุดูุฏ.

2. **ููุงุณู ุจุฑุฏุงุฑ ูพุฑุณุด ุจุง ุจุฑุฏุงุฑูุง ุงุณูุงุฏ**
   ุงู ุจุฑุฏุงุฑ ูพุฑุณุด ุจุง ุชูุงู ุจุฑุฏุงุฑูุง ุฐุฎุฑู ุดุฏู ุฏุฑ **vector store** ููุงุณู ูโุดูุฏ ุชุง ุดุจุงูุช ูุญุงุณุจู ุดูุฏ. ูุนุงุฑูุง ูุนููู ุจุฑุง ุดุจุงูุช ุจุฑุฏุงุฑ ุนุจุงุฑุชโุงูุฏ ุงุฒ:

   * **cosine similarity** (ุนูููโุชุฑู ูุนุงุฑ ุดุจุงูุช)ุ
   * **inner product**ุ
   * **dot product** ุง **euclidean distance** 


3. **ูุฑุชุจโุณุงุฒ ุงุณูุงุฏ ุจุฑ ุงุณุงุณ ุจุดุชุฑู ุดุจุงูุช**
   ุจุฑ ุงุณุงุณ ููุฏุงุฑ ุดุจุงูุช ูุญุงุณุจูโุดุฏูุ ุงุณูุงุฏ ุฑุง ุฑุชุจูโุจูุฏ ูโฺฉูุฏ.

4. **ุจุงุฒฺฏุฑุฏุงูุฏู ุจูุชุฑู ูุชุงุฌ**
    `k` ุนุฏุฏ ุงุฒ ุจุงูุงุชุฑู ูุชุงุฌ ุฑุง ุจุงุฒูโฺฏุฑุฏุงูุฏ ฺฉู ุฏุฑ `search_kwargs={"k": 2}` ุชุนู ูโุดููุฏ (ุฏุฑ ูุซุงู  ฒ ุณูุฏ). 



**ูุนุงุฑ ุดุจุงูุช**
ุฏุฑ ุนููุ ูุนุงุฑ ุดุจุงูุช ุจู ุดูุง ูโฺฏูุฏ ฺูุฏุฑ ุฏู ุจุฑุฏุงุฑ **ููโุฌูุช ุง ูุดุงุจู** ูุณุชูุฏ:

โ **Cosine similarity (ุฑุงุฌโุชุฑู)**

ุงู ูุนุงุฑ ุจุฑุงุณุงุณ **ุฒุงูู** ุจู ุฏู ุจุฑุฏุงุฑ ูุญุงุณุจู ูโุดูุฏ:

* ููุฏุงุฑ **+1** ุนู ฺฉุงููุงู ูุดุงุจูุ
* ููุฏุงุฑ **0** ุนู ุจโุงุฑุชุจุงุทุ
* ููุฏุงุฑ **-1** ุนู ูุฎุงูู ููููู.

ูพุงฺฏุงูโูุง ุจุฑุฏุงุฑ (ูุซู FAISSุ Weaviateุ Milvusุ Typesense ูโฆ) ูุนูููุงู ููู ูุนุงุฑ ุฑุง ุจุฑุง ุดุจุงูุช ุณูุฏ/ูพุฑุณุด ุงุณุชูุงุฏู ูโฺฉููุฏ.


#### 2. `"mmr"`:  
ุฌุณุชุฌู ูุจุชู ุจุฑ **Maximal Marginal Relevance**: ุนู ุงุณูุงุฏ ุงูุชุฎุงุจ ูโุดููุฏ ฺฉู ูู ุจู ูพุฑุณุด ุดุจูโุงูุฏุ ูู ูุณุจุช ุจู ูู ุชููุน ุฏุงุฑูุฏุ ููุงุณุจ ููุช ูุฌููุนูู ุงุณูุงุฏ ุฎู ุดุจู ุจู ูู ูุณุชูุฏ ู ูโุฎูุงูู ูุชุงุฌ ูุชููุนโุชุฑ ุจฺฏุฑู.

ูุฏู ุงู ุฑูุด ุงู ุงุณุช ฺฉู **ููุฒูุงู ุฏู ฺุฒ ุฑุง ุจููู ฺฉูุฏ:**

1.  **ุงุฑุชุจุงุท ุจุง ุณูุงู (relevance)** โ ูุซู ุฌุณุชุฌู ุดุจุงูุช ูุนููู
2.  **ุชููุน ูุชุงุฌ (diversity)** โ ุนู ูุชุงุฌ ฺฉู ุงุฒ ูุธุฑ ูุญุชูุง ุจุง ูู *ุฎู ูุดุงุจู ูุจุงุดูุฏ* ุง ุงุทูุงุนุงุช ุชฺฉุฑุงุฑ ูุฏููุฏ

ุจูโุนุจุงุฑุช ุฏฺฏุฑุ MMR ุชูุงุด ูโฺฉูุฏ ุชุง:

* ูุชุงุฌ ุงูุชุฎุงุจ ฺฉูุฏ ฺฉู ูู ูุฒุฏฺฉ ุจู ูพุฑุณุด ุจุงุดูุฏุ
* ู ูู ุงุฒ ูุฑ ูุธุฑ ูุฑุงุฑ ฺฏุฑูุชู ฺูุฏ ูุชุฌู ุฎู ุดุจู ุจู ูู ุฏุฑ ุฎุฑูุฌ ุฑุง ฺฉุงูุด ุฏูุฏ. 

**ฺุทูุฑ MMR ฺฉุงุฑ ูโฺฉูุฏุ**

ูุฑุถ ฺฉูุฏ ุงุฒ ฺฉ **ูพุงฺฏุงู ุจุฑุฏุงุฑ (Vector Store)** ูุซู FAISS ุง Milvus ุงุณุชูุงุฏู ูโฺฉูุฏ.

ฑ) ุงุจุชุฏุง ฺฉ **ูุฌููุนูู ุงููู ุงุฒ ูุชุงุฌ** ูโฺฏุฑุฏ (ูุซูุงู ุจุง `fetch_k`)
ฒ) ุณูพุณ ุงูฺฏูุฑุชู MMR ุจูโุตูุฑุช **ุชฺฉุฑุงุฑ** ุจูุชุฑู ุณูุฏ ุฑุง ุงูุชุฎุงุจ ูโฺฉูุฏ:


$$
\text{MMR}(D_i) = \arg\max_{D_i \in R \setminus S} \left[ \lambda \cdot \text{Sim}(D_i, Q) - (1 - \lambda) \cdot \max_{D_j \in S} \text{Sim}(D_i, D_j) \right]
$$

<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/MMR.png" alt="mmr" style="width: 75%; height: 75%; object-fit: contain;">
</div>
<p class="wp-caption-text" style="margin-top: 8px; color: #555; align-items: center; text-align: center;">
Maximum Marginal Relevance (MMR)
</p>



ุจุฑุง ูุฑ ุงูุชุฎุงุจ:

 ุงูุชุงุฒ ููุง ุณูุฏ `D_i` ุจุฑุงุจุฑ ุงุณุช ุจุง:

```
ฮป * sim(query, D_i)  -  (1 - ฮป) * max(sim(D_i, selected_docs))
```

ฺฉู ุฏุฑ ุขู:

* `sim(query, D_i)` ูุดุงูโุฏููุฏู ุดุจุงูุช ุณูุฏ ุจู ูพุฑุณุด ุงุณุช
* `sim(D_i, selected_docs)` ูุดุงูโุฏููุฏู ุดุจุงูุช ุจุง ุงุณูุงุฏ ุงุณุช ฺฉู ูุจูุงู ุงูุชุฎุงุจ ุดุฏูโุงูุฏ
* `ฮป` (lambda_mult) ุนุฏุฏ ุจู **0 ู 1** ุงุณุช ฺฉู ูุฒุงู ุงูููุช ุจู ุดุจุงูุช ู ุชููุน ุฑุง ุชุนู ูโฺฉูุฏ


**ููุด ูพุงุฑุงูุชุฑูุง ููู ุฏุฑ `search_kwargs`**

ูพุงุฑุงูุชุฑูุง ฺฉู ูโุชูุงูุฏ ุจุฑุง MMR ุชูุธู ฺฉูุฏ ุนุจุงุฑุชโุงูุฏ ุงุฒ:

ุณุชูู ุขุฎุฑ ุฌุฏูู ุญุฐู ุดุฏ:

| ูพุงุฑุงูุชุฑ                     | ูุนูุง ุชุฎุตุต                                                                                                            |
| --------------------------- | ---------------------------------------------------------------------------------------------------------------------- |
| **k**                       | ุชุนุฏุงุฏ ููุง ุงุณูุงุฏ ฺฉู ูโุฎูุงูุฏ ุฎุฑูุฌ ุฏุงุฏู ุดูุฏ                                                                               |
| **fetch_k**                 | ุชุนุฏุงุฏ ุงููู ุงุณูุงุฏ ฺฉู ูุจู ุงุฒ ุงุนูุงู ุงูฺฏูุฑุชู MMR ุจุงุฒุงุจ ูโุดููุฏ (ุญูุถู ุงูุชุฎุงุจ)                                           |
| **lambda_mult (ุง lambda)** | ูุฒู *ุงุฑุชุจุงุท ุจุง ูพุฑุณุด* ุฏุฑ ููุงุจู *ุชููุน*:<br> โ ูุฒุฏฺฉ ุจู 1 โ ุชูุฑฺฉุฒ ุจุดุชุฑ ุฑู ุดุจุงูุช<br> โ ูุฒุฏฺฉ ุจู 0 โ ุชูุฑฺฉุฒ ุจุดุชุฑ ุฑู ุชููุน |



ูุซุงู:

```python
retriever = vectorstore.as_retriever(
    search_type="mmr",
    search_kwargs={"k": 5, "fetch_k": 20, "lambda_mult": 0.5},
)
```

ุนู:
 - ุงุฒ ุงุจุชุฏุง ฒฐ ุณูุฏ ูุดุงุจู ุณุคุงู ฺฏุฑูุชู ูโุดูุฏ
 - ุณูพุณ ต ููุฑุฏ ุงุฒ ุจู ุขูโูุง ุงูุชุฎุงุจ ูโุดูุฏ
 - ุทูุฑ ฺฉู ูุณุจุช **ุชุนุงุฏู ุจู ุงุฑุชุจุงุท ู ุชููุน** ุจุฑุงุจุฑ **ฐูซต** ุจุงุดุฏ.


<div style="background-color: #fff8b3; padding: 10px; border-radius: 8px;">
> ูโุชูุงูุฏ ุฌูุช ุขุดูุง ุจุดุชุฑ ุจุง Maximal Marginal Relevance (MMR) ููุงูุงุช ุขููุฒุด ุฒุฑ ุฑุง ูุทุงูุนู ฺฉูุฏ:<br>
 โ <a href="https://www.kaggle.com/code/marcinrutecki/rag-mmr-search-in-langchain" target="_blank">
RAG: MMR Search in LangChain (Kaggle)</a><br>
โ <a href="https://medium.com/tech-that-works/maximal-marginal-relevance-to-rerank-results-in-unsupervised-keyphrase-extraction-22d95015c7c5" target="_blank">
Maximal Marginal Relevance to Re-rank results in Unsupervised KeyPhrase Extraction (Medium)</a><br>
โ <a href="https://www.elastic.co/search-labs/blog/maximum-marginal-relevance-diversify-results" target="_blank">
Diversifying search results with Maximum Marginal Relevance (elastic search labs)</a>
</div>


#### 3. `"similarity_score_threshold"`:  
ุฌุณุชุฌู ุจุง ุขุณุชุงููู ุดุจุงูุช: ููุท ุงุณูุงุฏ ุจุฑฺฏุฑุฏุงูุฏู ูโุดููุฏ ฺฉู ุดุจุงูุชโุดุงู ูุณุจุช ุจู ูพุฑุณุด ุจุงูุงุชุฑ ุงุฒ ฺฉ ุขุณุชุงูู (threshold) ูุดุฎุต ุจุงุดุฏ.


ุฏุฑ LangChain ููุช `search_type="similarity_score_threshold"` ุฑุง ุจุฑุง **retriever** ุงูุชุฎุงุจ ูโฺฉูุฏุ ุงูฺฏูุฑุชู ุจุงุฒุงุจ ุงุณูุงุฏ ุงุฒ ุจุฑุฏุงุฑูุง **ูู ููุท ุจุฑุงุณุงุณ ุดุจุงูุช (ูุซู ุญุงูุช โsimilarityโ)** ุจูฺฉู ุจุง **ููุชุฑ ฺฉุฑุฏู ูุชุงุฌ ุจุฑ ุงุณุงุณ ฺฉ ุขุณุชุงููู ุญุฏุงูู ุดุจุงูุช (similarity score)** ุงูุฌุงู ูโุดูุฏ. ุนู ูุชุงุฌ ฺฉู ุงุฒ ูุธุฑ ูุนูุง ุง ุจุฑุฏุงุฑ ุจู ุงูุฏุงุฒู ฺฉุงู ูุฒุฏฺฉ ุจู ูพุฑุณุด ูุจุงุดูุฏุ **ุงุตูุงู ุจุงุฒฺฏุฑุฏุงูุฏู ููโุดููุฏ**. 


 **ููููู ู ูุฏู โsimilarity_score_thresholdโ**

ุฏุฑ ุฌุณุชุฌู ูุนููู ยซsimilarityยปุ ููุดู `k` ุชุนุฏุงุฏ ุณูุฏ ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ โ ุญุช ุงฺฏุฑ ุฎู ฺฉู ุจู ูพุฑุณุด ูุฑุชุจุท ุจุงุดูุฏ.
ุงูุง ุฏุฑ **similarity_score_threshold**:

ุจู retriever ูโฺฏูุฏ:
- ููุท ุงุณูุงุฏ ุฑุง ุจุฑฺฏุฑุฏุงู ฺฉู **score (ุงูุชุงุฒ ุดุจุงูุช) โฅ ฺฉ ุนุฏุฏ ูุดุฎุต (threshold)** ุจุงุดูุฏ.
- ุงฺฏุฑ ูฺ ุณูุฏ ูุชูุงูุฏ ุงู ุดุฑุท ุฑุง ุจุฑุขูุฑุฏู ฺฉูุฏุ ุฎุฑูุฌ ููฺฉู ุงุณุช **ุฎุงู** ุดูุฏ.

ุงู ุฑูุด ุฒูุงู ุฎู ููุฏ ุงุณุช ฺฉู:

- ูโุฎูุงูุฏ ููุท ุงุณูุงุฏ **ูุงูุนุงู ูุฑุชุจุท** ุจุฑฺฏุฑุฏูุฏุ
- ููโุฎูุงูุฏ ุฌูุงุจโูุง ุถุนู ุง ฺฉูโุฑุจุท ูุงุฑุฏ RAG ุดููุฏุ
- ุง ูพุงุณุฎ ุจุงุฏ **ุงุณุชุงูุฏุงุฑุฏ ฺฉูุช ุจุงูุง** ุฏุงุดุชู ุจุงุดุฏ ุจุฏูู ููุฒ ุถุนู.



**ูุญูู ุนููฺฉุฑุฏ:**

ููุช ุงุฒ ุงู ููุน ุงุณุชูุงุฏู ูโฺฉูุฏุ LangChain ุฏุฑ ูพุดุช ุตุญูู ฺูู ฺฉุงุฑ ุงูุฌุงู ูโุฏูุฏ:

1. **ุดุจุงูุช ุจุฑุง ูููู ุงุณูุงุฏ ูุญุงุณุจู ูโุดูุฏ** โ ูุงููุฏ ุญุงูุช โsimilarityโ.
2. **ฺฉ ูุณุช ุงุฒ (doc, similarity_score)** ุจุฑฺฏุฑุฏุงู ูโุดูุฏ.
3. ุณูพุณ ูุณุช ุฑุง **ููุชุฑ ูโฺฉูุฏ** ููุท ุจุฑ ุงุณุงุณ `score >= score_threshold`.
4. **ุชููุง ุงุณูุงุฏ ุจุงูโูุงูุฏู** ุฑุง ุจู ุนููุงู ุฎุฑูุฌ retriever ุชุญูู ูโุฏูุฏ.

ูฺฉุชู:
- `score_threshold` ุจุงุฏ ุนุฏุฏ **float ุจู 0 ุชุง 1** ุจุงุดุฏ ู ุจุฏูู ุขู ุฎุทุง ูโุฏูุฏ.


**ูพุงุฑุงูุชุฑูุง ููู**

| ูพุงุฑุงูุชุฑ             | ูุนู                                                                                        |
| ------------------- | ------------------------------------------------------------------------------------------- |
| **score_threshold** | ุญุฏุงูู ููุฏุงุฑ ุดุจุงูุช ูุงุฒู ุจุฑุง ูพุฐุฑุด ุณูุฏ. ุจุฑุง ูุซุงู: `0.8` ุนู ููุท ุงุณูุงุฏ ุจุง ุดุจุงูุช โฅ 0.8 ุจุฑฺฏุดุช ุฏุงุฏู ุดูุฏ. |
| **k** *(ุงุฎุชุงุฑ)*   | ุญุฏุงฺฉุซุฑ ุชุนุฏุงุฏ ุณูุฏ ูุจู ุงุฒ ููุชุฑ ุง ููุฑุงู ุจุง ููุชุฑ โ ุจุณุชู ุจู ูพุงุฏูโุณุงุฒ DB                     |



ูุซุงู:

```python
retriever = vector_store.as_retriever(
    search_type="similarity_score_threshold",
    search_kwargs={"score_threshold": 0.75, "k": 10}
)
```

**ุงู ุนู:**
- ุงุจุชุฏุง ุชุง ฑฐ ุณูุฏ ุดุจุงูุช ุจุงูุง ุฑุง ูพุฏุง ฺฉู
- ุณูพุณ ููุท ุขููุง ุฑุง ูฺฏู ุฏุงุฑ ฺฉู similarity โฅ 0.75 ุจุงุดูุฏ. 

---

<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/similarity_score_threshold.jpg" alt="similarity_score_threshold" style="width: 75%; height: 75%; object-fit: contain;">
</div>
<p class="wp-caption-text" style="margin-top: 8px; color: #555; align-items: center; text-align: center;">
Similarity Score Threshold
</p>



#### `search_kwargs={"k": 2}`:
  ุนู ยซุฏูยป ุณูุฏ ุจุฑุชุฑ (ุฏู Document) ุจุงุฒฺฏุฑุฏุงูุฏู ุดููุฏ. 
ุงฺฏุฑ `k` ูุดุฎุต ูุดูุฏุ ููุฏุงุฑ ุขู ุจูโุทูุฑ ูพุด ูุฑุถ 4 ุงุณุช.

**ูุญูู ุงุณุชูุงุฏู ุงุฒ Retriever ุจุฑุง ุจุงุฒุงุจ ุงุณูุงุฏ ูุดุงุจู ุจู ุฏุฑุฎูุงุณุช ฺฉุงุฑุจุฑ:**

```python
chatbot_response = retriever.batch(
    [
       user_input
    ],
    )
```

## ูุญูู ุงุฌุฑุง
ุงฺฉููู ุฏุฑ VS Codeุ ฺฉ Terminal ุฏุฑ ูุณุฑ ฺฉู ูุงู ุจุฑูุงูู ูุฑุงุฑ ุฏุงุฑุฏ ุงุฌุงุฏ ฺฉูุฏ (Terminal โ New Terminal)ุ ู ุฏุณุชูุฑ ุฒุฑ ุฑุง ูุงุฑุฏ ฺฉูุฏ.

```
>Streamlit run filename.py
```
ุฏุฑ ูุณูุช filename.py ูุงู ุจุฑูุงูู ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ.


ุงฺฏุฑ ุจุฑูุงูู ุจูโุฏุฑุณุช ู ุจุฏูู ุฎุทุง ุงุฌุฑุง ุดูุฏ ุฎุฑูุฌ ุฒุฑ ุฑุง ูุดุงูุฏู ูโฺฉูุฏ:
<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/out1.png" alt="output_sample" style="width: 75%; height: 75%; object-fit: contain;">
</div>

## ฺฉุฏ ุชูุงู ุจุฑูุงูู

```python
import streamlit as st
import pandas as pd
from langchain_core.documents import Document
import getpass
from dotenv import load_dotenv
import os
from langchain_google_genai import GoogleGenerativeAIEmbeddings
import faiss
from langchain_community.docstore.in_memory import InMemoryDocstore
from langchain_community.vectorstores import FAISS
#-------------------------------------------------

# Page config
st.set_page_config(page_title="ฺุช ุจุงุช ุณูุฑ", layout="wide", initial_sidebar_state="collapsed")

# Custom CSS for styling
st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700;800&display=swap');
    
    @font-face {
        font-family: 'Vazirmatn';
        font-weight: normal;
        font-style: normal;
    }
    
    * {
        font-family: 'Vazirmatn', 'Inter', sans-serif;
        
            }
    
    /* Keep English text left-to-right */
    .stChatInput input {
        direction: rtl;
        text-align: right;
    }
    
    .stApp {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .main {
        background: transparent;
    }
    
    .chat-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .user-message {
        background: #C8EDA9;
        color: black;
        border: none;
        border-radius: 20px 20px 5px 20px;
        padding: 18px 24px;
        margin: 10px -60px;
        font-size: 17px;
        max-width: 70%;
        box-shadow: 0 8px 16px rgba(102, 126, 234, 0.25);
        line-height: 1.6;
        margin-left: auto;
        direction: rtl;
        text-align: right;
    }
    
    .bot-message {
        background: white;
        color: #2d3748;
        border: none;
        border-radius: 20px 20px 5px 20px;
        padding: 18px 24px;
        margin: 10px -60px;
        font-size: 17px;
        max-width: 70%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        line-height: 1.6;
        margin-left: auto;
        direction: rtl;
        text-align: right;
    }
    
    .bot-message-title {
        background: linear-gradient(135deg, #f093fb 0%, #6c9e72 100%);
        color: white;
        border: none;
        border-radius: 20px 20px 5px 20px;
        padding: 18px 24px;
        margin: 10px -60px;
        font-size: 20px;
        font-weight: bold;
        max-width: 70%;
        box-shadow: 0 8px 16px rgba(245, 87, 108, 0.25);
        margin-left: auto;
        direction: rtl;
        text-align: right;
        display: inline-block;
    
    }
    
    .bot-message-images {
        background: #8ae6ab;
        color: #2d3748;
        border: none;
        border-radius: 20px 20px 5px 20px;
        padding: 18px 24px;
        margin: 10px -60px;
        font-size: 20px;
        font-weight: bold;
        max-width: 70%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        margin-left: auto;
        direction: rtl;
        text-align: center;
    }
    
    .bot-message-titleimages {
        background: #faca8e;
        color: black;
        border: none;
        border-radius: 20px 20px 5px 20px;
        padding: 18px 24px;
        margin: 10px -60px;
        font-size: 20px;
        font-weight: bold;
        max-width: 70%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        margin-left: auto;
        direction: rtl;
        text-align: center;
    }

    .user-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .bot-icon {
        width: 50px;
        height: 50px;
        background: white;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .stChatMessage {
        background-color: transparent !important;
    }
    
    .stChatInput {
        background: white;
        border-radius: 25px;
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .chat-header {
        text-align: center;
        color: white;
        padding: 30px 0 20px 0;
        font-size: 42px;
        font-weight: 600;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .image-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin-top: 12px;
        direction: rtl;
    }
    
    .image-item {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
            /* Fix image columns for RTL */
    .stColumns {
        direction: rtl;
    }
    
    .stColumn {
        direction: rtl;
    }
    .camera-icon {
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, #f093fb 0%, #57ccf5 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        box-shadow: 0 4px 8px rgba(245, 87, 108, 0.3);
    }
    
   
    /* Smooth animations */
    .user-message, .bot-message, .bot-message-title, .bot-message-images {
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Input styling */
    .stChatInput > div > div {
        background: #2e753a;
        backdrop-filter: blur(10px);
        border-radius: 30px;
    }
    
    .stChatInput {
        background: white;
        border-radius: 25px;
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
            
            input::placeholder,
   textarea::placeholder {
    font-family: 'Vazirmatn', sans-serif;
    font-size: 16px;
    color: #888;
    opacity: 1;
    }         
input, textarea {
    font-family: 'Vazirmatn', sans-serif !important;
    text-align: right;
    direction: rtl;
            }
input::placeholder,
textarea::placeholder {
  font-family: 'Vazirmatn', sans-serif !important;
text-align: right;
            direction: rtl;
            }
      
            </style>
""", unsafe_allow_html=True)
#------------------------------------------------------

#-----------------------------------------#
#----1. Documents and Document Loaders----#
city_data = pd.read_excel("city_data.xlsx")
documents = []
print("Building Langchain Document")
for i, row in city_data.iterrows():
    city_name = row['city_name']
    city_description = row['description']

    doc = Document(
        page_content=city_description,
        metadata={"city_name": city_name},
    )
    documents.append(doc)

print("Done.")
print("number of documents:", len(documents))
print("_"*40)

#------------------------#
#-----2. Embeddings------#
print("Step 2. Embeddings")
load_dotenv()

if not os.environ.get("GOOGLE_API_KEY"):
    os.environ["GOOGLE_API_KEY"] = getpass.getpass("Enter API key for Google Gemini: ")

print("API key Loaded.")

embeddings = GoogleGenerativeAIEmbeddings(model="models/gemini-embedding-001")
print("Embedding model loaded: gemini-embedding-001")

#------------------------#
#----3. Vector stores----#
print("Step 3. Vector stores")
embedding_dim = len(embeddings.embed_query("hello world"))
index = faiss.IndexFlatL2(embedding_dim)

vector_store = FAISS(
    embedding_function=embeddings,
    index=index,
    docstore=InMemoryDocstore(),
    index_to_docstore_id={},
)
ids = vector_store.add_documents(documents=documents)

# Save to disk
vector_store.save_local("city_data_faiss_index")
#------------------------#
#----4. Retriever----#
print("Step 4. Retriever")

# Load from disk later
loaded_store = FAISS.load_local("city_data_faiss_index", embeddings, allow_dangerous_deserialization=True)
retriever = loaded_store.as_retriever(
    search_type="similarity",
    search_kwargs={"k": 2},
)


#------------------------------------------------------
# Initialize session state
if 'messages' not in st.session_state:
    st.session_state.messages = [
        {"role": "assistant", "content": "ฺุทูุฑ ูุชููู ฺฉูฺฉ ุชูู ฺฉููุ", "type": "text"}
    ]


def get_images(city_name):
    """    
    Returns:
        A dictionary mapping place_name -> list_of_image_paths
    """
    
    city_path = os.path.join("dataset", "cities", city_name)
    if not os.path.isdir(city_path):
        raise FileNotFoundError(f"City folder not found: {city_path}")

    result = {}

    # iterate over place folders
    for place_name in os.listdir(city_path):
        place_path = os.path.join(city_path, place_name)

        if os.path.isdir(place_path):
            # collect all image file paths in this place folder
            images = [
                os.path.join(place_path, f)
                for f in os.listdir(place_path)
                if f.lower().endswith(('.png', '.jpg', '.jpeg', '.bmp', '.tiff'))
            ]

            result[place_name] = images

    return result


def get_city_recommendations():
    """Return default city recommendations"""
    return [CITY_DATA["city1"], CITY_DATA["city2"]]

# Header
st.markdown('<div class="chat-header"> ุฏุณุชุงุฑ ุณูุฑ โ๏ธ </div>', unsafe_allow_html=True)

# Display chat messages
for i, message in enumerate(st.session_state.messages):
    if message["role"] == "user":
        col1, col2 = st.columns([11, 1])
        with col1:
            st.markdown(f'<div class="user-message">{message["content"]}</div>', unsafe_allow_html=True)
        with col2:
            st.markdown('<div class="user-icon">๐ค</div>', unsafe_allow_html=True)
    else:
        col1, col2 = st.columns([11, 1])
        with col1:
            if message.get("type") == "images":
                st.markdown(f'<div class="bot-message-images">{message["content"]}</div>', unsafe_allow_html=True)
                if "images" in message:
                    cols = st.columns(4)
                    for idx, img_url in enumerate(message["images"][:3]):
                        with cols[idx]:
                            st.image(img_url, width='stretch')
                    with cols[3]:
                        pass
                        # st.markdown('<div class="camera-icon">๐ท</div>', unsafe_allow_html=True)
            elif message.get("type") == "titleimages":
                st.markdown(f'<div class="bot-message-titleimages">{message["content"]}</div>', unsafe_allow_html=True)
            elif message.get("type") == "title":
                st.markdown(f'<div class="bot-message-title">{message["content"]}</div>', unsafe_allow_html=True)
            else:
                st.markdown(f'<div class="bot-message">{message["content"]}</div>', unsafe_allow_html=True)
        with col2:
            st.markdown('<div class="bot-icon">๐ค</div>', unsafe_allow_html=True)


# Chat input
st.markdown("<br>", unsafe_allow_html=True)
user_input = st.chat_input("ูพุงู ุฎูุฏ ุฑุง ุชุงูพ ฺฉูุฏ...")

if user_input:
    chatbot_response = retriever.batch(
    [
       user_input
    ],
    )

    city1_description = chatbot_response[0][0].page_content
    city1_name = chatbot_response[0][0].metadata["city_name"]

    city2_description = chatbot_response[0][1].page_content
    city2_name = chatbot_response[0][1].metadata["city_name"]


    # City data
    CITY_DATA = {
        "city1": {
            "name": city1_name,
            "description": city1_description,
            "popular_places_info": get_images(city1_name)
        },
        "city2": {
            "name": city2_name,
            "description": city2_description,
            "popular_places_info": get_images(city2_name)
        }
    }

    # Add user message
    st.session_state.messages.append({"role": "user", "content": user_input})
    
    # Get city recommendations
    cities = get_city_recommendations()
    
    # Add bot responses for each city
    for idx, city in enumerate(cities, 1):
        # City name
        st.session_state.messages.append({
            "role": "assistant",
            "content": f"ุดูุฑ ุดูุงุฑู {idx}: {city['name']}",
            "type": "title"
        })
        
        # City description
        st.session_state.messages.append({
            "role": "assistant",
            "content": city['description'],
            "type": "text"
        })
        
        st.session_state.messages.append({
                "role": "assistant",
                "content": f"ุจุฑุฎ ูฺฉุงู ูุง ุฏุฏู {city['name']}",
                "type": "titleimages"
            })
        for name, images in city['popular_places_info'].items():
            # City images
            st.session_state.messages.append({
                "role": "assistant",
                "content": f" ุชุตุงูุฑ {name} ๐ท",
                "type": "images",
                "images": images
            })
    
    st.rerun()

print('end of running')
```

## ููููู ุฎุฑูุฌ ุจุฑูุงูู 
<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/out1.png" alt="out1" style="width: 75%; height: 75%; object-fit: contain;">
</div>

<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/out2.png" alt="out2" style="width: 75%; height: 75%; object-fit: contain;">
</div>

<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/out3.png" alt="out3" style="width: 75%; height: 75%; object-fit: contain;">
</div>

<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/out4.png" alt="out4" style="width: 75%; height: 75%; object-fit: contain;">
</div>

<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/out5.png" alt="out5" style="width: 75%; height: 75%; object-fit: contain;">
</div>
<p class="wp-caption-text" style="margin-top: 8px; color: #555; align-items: center; text-align: center;">
ุฎุฑูุฌ ุจุฑูุงูู ุจุฑุง ูุฑูุฏ "ูุฎูุงูู ุจู ุณูุฑ ุฒุงุฑุช ุจุฑููุ ฺูุฏ ุดูุฑ ูพุดููุงุฏ ุจุฏู."
</p>

<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/out6.png" alt="out6" style="width: 75%; height: 75%; object-fit: contain;">
</div>

<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/out7.jpeg" alt="out7" style="width: 75%; height: 75%; object-fit: contain;">
</div>

<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/out8.png" alt="out8" style="width: 75%; height: 75%; object-fit: contain;">
</div>

<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
    <img src="/assets/patterneffort/TOURIST_ASSISTANT/out9.png" alt="out9" style="width: 75%; height: 75%; object-fit: contain;">
</div>
<p class="wp-caption-text" style="margin-top: 8px; color: #555; align-items: center; text-align: center;">
ุฎุฑูุฌ ุจุฑูุงูู ุจุฑุง ูุฑูุฏ "ฺูุฏ ุดูุฑ ุชูุฑุณุช ู ุฏุฑุง ุจฺฏู"
</p>


## ููุงุจุน

1. <a href="https://docs.langchain.com/oss/python/langchain/knowledge-base#concepts" target="_blank"><strong>Build a semantic search engine with LangChain</strong></a>  
2. <a href="https://docs.langchain.com/oss/python/integrations/retrievers" target="_blank"><strong>Retrievers</strong></a>  
3. <a href="https://docs.streamlit.io/" target="_blank"><strong>Streamlit documentation</strong></a>  
4. <a href="https://forum.langchain.com/t/how-to-add-scores-to-qdrant-vectorstore-retriever-results-when-mmr-is-used/1781?utm_source=chatgpt.com" target="_blank"><strong>How to add scores to Qdrant vectorstore retriever results when MMR is used?</strong></a>  
5. <a href="https://www.kaggle.com/code/marcinrutecki/rag-mmr-search-in-langchain" target="_blank"><strong>RAG: MMR Search in LangChain (Kaggle)</strong></a>  
